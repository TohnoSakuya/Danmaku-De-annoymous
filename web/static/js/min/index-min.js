function bind(e,t,n){var r=document.querySelectorAll(e);if(r)for(var l=0;l<r.length;l++)r[l].addEventListener(t,n)}function show(e){var t=document.getElementById(e);t.style.display="",t.scrollIntoView()}function hide(e){document.getElementById(e).style.display="none"}function disable(e){document.getElementById(e).disabled=!0}function enable(e){document.getElementById(e).disabled=!1}function getComment(e){var t=new XMLHttpRequest;t.open("GET","http://comment.bilibili.com/"+e+".xml",!0),show("loader"),disable("getComment"),t.onload=function(){if(hide("loader"),t.status>=200&&t.status<400){disable("vurl");var e=new DOMParser,n=e.parseFromString(t.responseText,"text/xml");window.commentElements=n.getElementsByTagName("d"),show("step2")}else enable("getComment"),$("#vurl").value="读取弹幕失败，重试或联系管理员"},t.onerror=function(){enable("getComment"),hide("loader"),$("#vurl").value="读取弹幕失败，重试或联系管理员"},t.send()}function cm_tmpl(e){var t=e.childNodes[0].nodeValue.replace(/"/g,"&quot;"),n=t;t.length>20&&(n=t.substr(0,20));var r=e.getAttribute("p").split(","),l=parseInt(r[0]),a=r[6],o=parseInt(l/60)%60,i=l%60,s='<tr><td class="mdl-data-table__cell--non-numeric" title="'+t+'">'+n+"</td><td>"+o+":"+i+'</td>                 <td><a id="cmid_'+a+'" href="javascript:;" class="cm-view-btn" onclick="getUser(\''+a+"')\">爆</a></td></tr>";return s}function getUser(e){for(var t=document.querySelectorAll("#cmid_"+e),n=0;n<t.length;n++)t[n].innerHTML="正在解析";var r=new XMLHttpRequest;r.open("GET",apiBase+"user/hash/"+e,!0),r.onload=function(){if(r.status>=200&&r.status<400){var e=JSON.parse(r.responseText);if(0==e.error)for(var n=e.data[0].id,l=0;l<t.length;l++)t[l].onclick=function(){},t[l].setAttribute("target","_blank"),t[l].href="http://space.bilibili.com/"+n,document.body.offsetWidth<600?t[l].innerHTML="进入":t[l].innerHTML="http://space.bilibili.com/"+n;else{alert("用户不存在，这条弹幕是非会员弹幕，也可能是此用户被 bishi 删了");for(var l=0;l<t.length;l++)t[l].innerHTML="用户不存在"}}else{alert("读取用户失败，服务器错误");for(var l=0;l<t.length;l++)t[l].innerHTML="解析失败"}},r.onerror=function(){alert("读取用户失败，网络错误"),t.innerHTML="网络错误"},r.send()}var $=function(e){var t=document.querySelectorAll(e);return t?1==t.length?t[0]:t:void 0};bind("#frm-vurl","submit",function(e){e.preventDefault&&e.preventDefault();var t=/\/video\/av(\d+)(\/index.html|\/index_(\d+).html)?/,n=$("#vurl").value,r=n.match(t);if(!r||!r[1])return $("#vurl").value="无效的视频地址",!1;var l=r[1],a=r[3]||1,o=new XMLHttpRequest;return o.open("GET",apiBase+"cid/"+l+"/"+a,!0),disable("getComment"),show("loader"),o.onload=function(){if(enable("getComment"),hide("loader"),o.status>=200&&o.status<400){var e=JSON.parse(o.responseText);0==e.error?(window.lastCID=e.cid,getComment(e.cid)):$("#vurl").value="请求错误，请一会再试或联系管理员"}else $("#vurl").value="服务器错误，请尝试刷新或联系管理员"},o.onerror=function(){enable("getComment"),hide("loader"),$("#vurl").value="服务器错误，请尝试刷新或联系管理员"},o.send(),!1}),bind("#frm-searchcm","submit",function(e){e.preventDefault&&e.preventDefault();var t=$("#cmsearch").value;if(!t)return!1;disable("searchComment"),show("loader");for(var n="",r=0;r<commentElements.length;r++){var l=commentElements[r].childNodes[0];if(l){var a=l.nodeValue;a&&a.indexOf(t)>-1&&(n+=cm_tmpl(commentElements[r]))}}return(!n||n.length<1)&&(n="<tr><td>没有找到任何弹幕，请尝试变更关键词</td></tr>"),$("#cmList").innerHTML=n,enable("searchComment"),hide("loader"),show("step3"),!1});